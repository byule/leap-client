var mt=Object.create;var O=Object.defineProperty,ut=Object.defineProperties,pt=Object.getOwnPropertyDescriptor,lt=Object.getOwnPropertyDescriptors,ht=Object.getOwnPropertyNames,me=Object.getOwnPropertySymbols,ft=Object.getPrototypeOf,pe=Object.prototype.hasOwnProperty,vt=Object.prototype.propertyIsEnumerable;var ue=(n,s,e)=>s in n?O(n,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[s]=e,d=(n,s)=>{for(var e in s||(s={}))pe.call(s,e)&&ue(n,e,s[e]);if(me)for(var e of me(s))vt.call(s,e)&&ue(n,e,s[e]);return n},P=(n,s)=>ut(n,lt(s));var gt=(n,s)=>{for(var e in s)O(n,e,{get:s[e],enumerable:!0})},le=(n,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let r of ht(s))!pe.call(n,r)&&r!==e&&O(n,r,{get:()=>s[r],enumerable:!(t=pt(s,r))||t.enumerable});return n};var p=(n,s,e)=>(e=n!=null?mt(ft(n)):{},le(s||!n||!n.__esModule?O(e,"default",{value:n,enumerable:!0}):e,n)),yt=n=>le(O({},"__esModule",{value:!0}),n);var N=(n,s,e)=>new Promise((t,r)=>{var i=a=>{try{c(e.next(a))}catch(l){r(l)}},o=a=>{try{c(e.throw(a))}catch(l){r(l)}},c=a=>a.done?t(a.value):Promise.resolve(a.value).then(i,o);c((e=e.apply(n,s)).next())});var Dt={};gt(Dt,{Client:()=>M,connect:()=>Ct,pair:()=>wt});module.exports=yt(Dt);var q=require("node-forge"),be=require("@mkellsy/hap-device");var ie=p(require("fs")),ge=p(require("path")),ye=p(require("net")),Se=require("bson"),Pe=require("node-forge"),L=require("uuid");var he=require("@mkellsy/event-emitter");var I=class{};var K=class n{constructor(s,e){this.message=s,this.code=e}static fromString(s){let e=s==null?void 0:s.split(" ",2);if(e==null||e.length===1)return new n(s);let t=parseInt(e[0],10);return Number.isNaN(t)?new n(s):new n(e[1],t)}isSuccessful(){return this.code!==void 0&&this.code>=200&&this.code<300}};var A=class n{constructor(){this.Header=new I}static parse(s){let e=JSON.parse(s),t=e.Header.StatusCode==null?void 0:K.fromString(e.Header.StatusCode),r=Object.assign({},e.Header,{StatusCode:t,MessageBodyType:e.Header.MessageBodyType});if(r.MessageBodyType==null)return Object.assign(new n,{Header:r});let i=Object.keys(e.Body||{})[0],o=i!=null&&e.Body[i]||void 0;return Object.assign(new n,e,{Header:r,Body:o})}};var U=class extends he.EventEmitter{constructor(){super(...arguments);this.buffer=""}parse(e,t){let r=this.buffer+e.toString(),i=r.split(/\r?\n/);if(i.length-1===0){this.buffer=r;return}this.buffer=i[i.length-1]||"";for(let o of i.slice(0,i.length-1))t(A.parse(o))}};var x=class{constructor(){this.Message=""}};var fe=require("@mkellsy/event-emitter"),Z=require("tls"),St=1e4,Pt=3e4,$=class extends fe.EventEmitter{constructor(e,t,r){super();this.onSocketData=e=>{this.emit("Data",e)};this.onSocketTimeout=()=>{this.emit("Error",new Error("connect ETIMEDOUT"))};this.onSocketClose=()=>{this.emit("Disconnect")};this.onSocketError=e=>{this.emit("Error",e)};this.host=e,this.port=t,this.certificate=r}connect(){return new Promise((e,t)=>{let r=(0,Z.connect)(this.port,this.host,{secureContext:(0,Z.createSecureContext)(this.certificate),secureProtocol:"TLS_method",rejectUnauthorized:!1});r.once("secureConnect",()=>{this.connection=r,this.connection.off("error",t),this.connection.on("timeout",this.onSocketTimeout),this.connection.on("error",this.onSocketError),this.connection.on("close",this.onSocketClose),this.connection.on("data",this.onSocketData),this.connection.setKeepAlive(!0,St),this.connection.setTimeout(Pt),e(this.connection.getProtocol()||"Unknown")}),r.once("error",t)})}disconnect(){var e,t;(e=this.connection)==null||e.end(),(t=this.connection)==null||t.destroy()}write(e){return new Promise((t,r)=>{if(this.connection==null)return r(new Error("connection not established"));this.connection.write(`${JSON.stringify(e)}
`,i=>i!=null?r(i):t())})}};var ve=8083,bt=8081,Tt=1e3,C=class extends U{constructor(e,t){super();this.secure=!1;this.teardown=!1;this.requests=new Map;this.subscriptions=new Map;this.onResponse=e=>{let t=e.Header.ClientTag;if(t==null){this.emit("Message",e);return}let r=this.requests.get(t);r!=null&&(clearTimeout(r.timeout),this.requests.delete(t),r.resolve(e));let i=this.subscriptions.get(t);i!=null&&(i.url.includes("/button/")&&i.url.includes("/status/event")&&console.error(`[PROCESSOR_RAW] URL: ${i.url}, Event: ${JSON.stringify(e.Body)}`),i.callback(e))};this.onSocketData=e=>{this.secure?this.parse(e,this.onResponse):this.emit("Message",JSON.parse(e.toString()))};this.onSocketDisconnect=()=>{this.teardown||this.emit("Disconnect")};this.onSocketError=e=>{this.emit("Error",e)};this.host=e,this.secure=t!=null,this.certificate=d({ca:"",cert:"",key:""},t!=null?t:this.authorityCertificate())}static reachable(e){return new Promise(t=>{let r=new ye.default.Socket,i=o=>{r.destroy(),t(o)};r.setTimeout(Tt),r.once("error",()=>i(!1)),r.once("timeout",()=>i(!1)),r.connect(ve,e,()=>i(!0))})}connect(){return new Promise((e,t)=>{this.teardown=!1,this.socket=void 0;let r=[...this.subscriptions.values()],i=new $(this.host,this.secure?bt:ve,this.certificate);i.on("Data",this.onSocketData),i.on("Error",this.onSocketError),i.on("Disconnect",this.onSocketDisconnect),i.connect().then(o=>{this.physicalAccess(this.secure).then(()=>{let c=[];if(this.subscriptions.clear(),this.socket=i,this.secure)for(let a of r)c.push(this.subscribe(a.url,a.listener));Promise.all(c).then(()=>{this.emit("Connect",o),e()})})}).catch(o=>t(o))})}disconnect(){var e;this.teardown=!0,this.secure&&this.drainRequests(),this.subscriptions.clear(),(e=this.socket)==null||e.disconnect()}read(e){return new Promise((t,r)=>{let i=(0,L.v4)();if(!this.secure)return r(new Error("Only available for secure connections"));this.sendRequest(i,"ReadRequest",e).then(o=>o.Body==null?r(new Error(`${e} no body`)):o.Body instanceof x?r(new Error(o.Body.Message)):t(o.Body)).catch(o=>r(o))})}authenticate(e){return new Promise((t,r)=>{var c;if(this.secure)return r(new Error("Only available for physical connections"));let i={Header:{RequestType:"Execute",Url:"/pair",ClientTag:"get-cert"},Body:{CommandType:"CSR",Parameters:{CSR:e.cert,DisplayName:"get_lutron_cert.py",DeviceUID:"000000000000",Role:"Admin"}}},o=setTimeout(()=>r(new Error("Authentication timeout exceeded")),5e3);this.once("Message",a=>{clearTimeout(o),t({ca:a.Body.SigningResult.RootCertificate,cert:a.Body.SigningResult.Certificate,key:Pe.pki.privateKeyToPem(e.key)})}),(c=this.socket)==null||c.write(i)})}update(e,t){return new Promise((r,i)=>{let o=(0,L.v4)();if(!this.secure)return i(new Error("Only available for secure connections"));this.sendRequest(o,"UpdateRequest",e,t).then(c=>c.Body instanceof x?i(new Error(c.Body.Message)):r(c.Body)).catch(c=>i(c))})}command(e,t){return new Promise((r,i)=>{let o=(0,L.v4)();if(!this.secure)return i(new Error("Only available for secure connections"));this.sendRequest(o,"CreateRequest",e,t).then(()=>r()).catch(c=>i(c))})}subscribe(e,t){return new Promise((r,i)=>{if(!this.secure)return i(new Error("Only available for secure connections"));let o=(0,L.v4)();this.sendRequest(o,"SubscribeRequest",e).then(c=>{c.Header.StatusCode!=null&&c.Header.StatusCode.isSuccessful()&&this.subscriptions.set(o,{url:e,listener:t,callback:a=>t(a.Body)}),r()}).catch(c=>i(c))})}drainRequests(){for(let e of this.requests.keys()){let t=this.requests.get(e);clearTimeout(t.timeout)}this.requests.clear()}sendRequest(e,t,r,i){return new Promise((o,c)=>{if(this.requests.has(e)){let l=this.requests.get(e);l.reject(new Error(`tag "${e}" reused`)),clearTimeout(l.timeout),this.requests.delete(e)}let a={CommuniqueType:t,Header:{ClientTag:e,Url:r},Body:i};if(this.socket==null)return c(new Error("Connection not established"));this.socket.write(a).then(()=>{this.requests.set(e,{message:a,resolve:o,reject:c,timeout:setTimeout(()=>o(A.parse(JSON.stringify({Header:{MessageBodyType:"ExceptionDetail"},Body:{Message:"Request timeout"}}))),5e3)})}).catch(l=>c(l))})}authorityCertificate(){let e=ge.default.resolve(__dirname,"../authority");if(ie.default.existsSync(e)){let t=ie.default.readFileSync(e);if(t==null)return null;let r=Se.BSON.deserialize(t);return r.ca=Buffer.from(r.ca,"base64").toString("utf8"),r.key=Buffer.from(r.key,"base64").toString("utf8"),r.cert=Buffer.from(r.cert,"base64").toString("utf8"),r}return null}physicalAccess(e){return new Promise((t,r)=>{if(e)return t();let i=setTimeout(()=>r(new Error("Physical timeout exceeded")),6e4);this.once("Message",o=>o.Body.Status.Permissions.includes("PhysicalAccess")?(clearTimeout(i),t()):r(new Error("Unknown pairing error")))})}};var H=class{constructor(s){let e=s.addresses.find(t=>t.family===be.HostAddressFamily.IPv4)||s.addresses[0];this.connection=new C(e.address)}authenticate(){return N(this,null,function*(){return new Promise((s,e)=>{this.connection.connect().then(()=>{this.createCertificateRequest("mkellsy-mqtt-lutron").then(t=>{this.connection.authenticate(t).then(r=>s(r)).catch(r=>e(r))}).catch(t=>e(t))}).catch(t=>e(t))})})}createCertificateRequest(s){return new Promise((e,t)=>{q.pki.rsa.generateKeyPair({bits:2048},(r,i)=>{if(r==null){let o=q.pki.createCertificationRequest();return o.publicKey=i.publicKey,o.setSubject([{name:"commonName",value:s}]),o.sign(i.privateKey),e({key:i.privateKey,cert:q.pki.certificationRequestToPem(o)})}return t(new Error("Error generating RSA keys"))})})}};var b=p(require("fs")),w=p(require("path")),oe=p(require("os")),ne=require("bson");var D=class{constructor(){this.context={};let s=this.open("pairing")||{},e=Object.keys(s);for(let t=0;t<e.length;t++)s[e[t]]=this.decrypt(s[e[t]]);this.context=s}get processors(){return Object.keys(this.context).filter(s=>s!=="authority")}has(s){return this.context[s]!=null}get(s){return this.context[s]}set(s,e){this.context[s.id]=d({},e),this.save("pairing",this.context)}decrypt(s){return s==null?null:(s.ca=Buffer.from(s.ca,"base64").toString("utf8"),s.key=Buffer.from(s.key,"base64").toString("utf8"),s.cert=Buffer.from(s.cert,"base64").toString("utf8"),s)}encrypt(s){return s==null?null:(s.ca=Buffer.from(s.ca).toString("base64"),s.key=Buffer.from(s.key).toString("base64"),s.cert=Buffer.from(s.cert).toString("base64"),s)}open(s){let e=w.default.join(oe.default.homedir(),".leap");if(b.default.existsSync(e)||b.default.mkdirSync(e),b.default.existsSync(w.default.join(e,s))){let t=b.default.readFileSync(w.default.join(e,s));return ne.BSON.deserialize(t)}return null}save(s,e){let t=w.default.join(oe.default.homedir(),".leap");b.default.existsSync(t)||b.default.mkdirSync(t);let r=d({},e),i=Object.keys(r);for(let o=0;o<i.length;o++)r[i[o]]=this.encrypt(r[i[o]]);b.default.writeFileSync(w.default.join(t,s),ne.BSON.serialize(r))}};var Te=p(require("os")),Ae=p(require("path")),Ce=p(require("deep-equal")),we=p(require("flat-cache")),De=require("@mkellsy/event-emitter"),z=require("tinkerhub-mdns"),ce=require("@mkellsy/hap-device"),E=class extends De.EventEmitter{constructor(){super();this.onAvailable=e=>{if(!this.isProcessorService(e))return;let t=this.parseProcessorAddress(e);this.isProcessorCached(t)||this.emit("Discovered",t),this.cacheProcessor(t)};this.cache=we.default.load("discovery",Ae.default.join(Te.default.homedir(),".leap")),this.cached=this.cache.getKey("/hosts")||[],this.cache.setKey("/hosts",this.cached),this.cache.save(!0)}search(){this.stop();for(let e=0;e<this.cached.length;e++)this.emit("Discovered",this.cached[e]);this.discovery=new z.MDNSServiceDiscovery({type:"lutron",protocol:z.Protocol.TCP}),this.discovery.onAvailable(this.onAvailable)}stop(){var e;(e=this.discovery)==null||e.destroy()}isProcessorCached(e){return this.cached.find(t=>(0,Ce.default)(t,e))!=null}isProcessorService(e){let t=e.data.get("systype");return!(t==null||typeof t=="boolean")}cacheProcessor(e){let t=this.cached.findIndex(r=>r.id===e.id);t>=0?this.cached[t]=e:this.cached.push(e),this.cache.setKey("/hosts",this.cached),this.cache.save()}parseProcessorAddress(e){var i;let t=this.discovery.serviceData.get(e.id).SRV._record.target,r=[];for(let o=0;o<((i=e.addresses)==null?void 0:i.length);o++)r.push({address:e.addresses[o].host,family:/^([\da-f]{1,4}:){7}[\da-f]{1,4}$/i.test(e.addresses[o].host)?ce.HostAddressFamily.IPv6:ce.HostAddressFamily.IPv4});return{id:t.match(new RegExp("[Ll]utron-(?<id>\\w+)\\.local")).groups.id.toUpperCase(),type:String(e.data.get("systype")),addresses:r}}};var ct=require("js-logger"),R=p(require("colors")),B=require("@mkellsy/hap-device"),at=require("@mkellsy/event-emitter");var Ee=require("js-logger"),ke=p(require("flat-cache")),Re=p(require("colors")),Be=p(require("os")),Oe=p(require("path")),xe=require("@mkellsy/event-emitter"),At=2e4,F=class extends xe.EventEmitter{constructor(e,t){super();this.discovered=new Map;this.onConnect=()=>{this.log.info("connected"),this.emit("Connect",this.connection)};this.onMessage=e=>{this.log.debug("message"),this.emit("Message",e)};this.onDisconnect=()=>{this.log.info("disconnected"),this.emit("Disconnect")};this.onError=e=>{this.emit("Error",e)};this.uuid=e,this.logger=(0,Ee.get)(`Processor ${Re.default.dim(this.id)}`),this.connection=t,this.cache=ke.default.load(e,Oe.default.join(Be.default.homedir(),".leap")),this.connection.on("Connect",this.onConnect),this.connection.on("Message",this.onMessage),this.connection.on("Error",this.onError),this.connection.once("Disconnect",this.onDisconnect)}get id(){return this.uuid}get log(){return this.logger}get devices(){return this.discovered}connect(){return new Promise((e,t)=>{this.connection.connect().then(()=>{this.startHeartbeat(),e()}).catch(r=>t(r))})}disconnect(){this.stopHeartbeat(),this.connection.disconnect()}clear(){for(let e of this.cache.keys())this.cache.removeKey(e);this.cache.removeCacheFile(),this.cache.save()}ping(){return this.read("/server/1/status/ping")}read(e){return this.connection.read(e)}project(){return new Promise((e,t)=>{let r=this.cache.getKey("/project");if(r!=null)return e(r);this.connection.read("/project").then(i=>{this.cache.setKey("/project",i),this.cache.save(!0),e(i)}).catch(i=>t(i))})}system(){return new Promise((e,t)=>{let r=this.cache.getKey("/device?where=IsThisDevice:true");if(r!=null)return e(r);this.connection.read("/device?where=IsThisDevice:true").then(i=>{if(i[0]!=null)return this.cache.setKey("/device?where=IsThisDevice:true",i[0]),this.cache.save(!0),e(i[0]);t(new Error("No system device found"))}).catch(i=>t(i))})}areas(){return new Promise((e,t)=>{let r=this.cache.getKey("/area");if(r!=null)return e(r);this.connection.read("/area").then(i=>{this.cache.setKey("/area",i),this.cache.save(!0),e(i)}).catch(i=>t(i))})}timeclocks(){return new Promise((e,t)=>{let r=this.cache.getKey("/timeclock");if(r!=null)return e(r);this.connection.read("/timeclock").then(i=>{this.cache.setKey("/timeclock",i),this.cache.save(!0),e(i)}).catch(i=>t(i))})}zones(e){return new Promise((t,r)=>{let i=this.cache.getKey(`${e.href}/associatedzone`);if(i!=null)return t(i);this.connection.read(`${e.href}/associatedzone`).then(o=>{this.cache.setKey(`${e.href}/associatedzone`,o),this.cache.save(!0),t(o)}).catch(o=>r(o))})}status(e){return this.read(`${e.href}/status`)}statuses(e){return new Promise((t,r)=>{let i=[];i.push(this.read("/zone/status")),i.push(this.read("/area/status")),e==="RadioRa3Processor"&&i.push(this.read("/timeclock/status")),Promise.all(i).then(([o,c,a])=>t([...o,...c,...a||[]])).catch(o=>r(o))})}controls(e){return new Promise((t,r)=>{let i=this.cache.getKey(`${e.href}/associatedcontrolstation`);if(i!=null)return t(i);this.connection.read(`${e.href}/associatedcontrolstation`).then(o=>{this.cache.setKey(`${e.href}/associatedcontrolstation`,o),this.cache.save(!0),t(o)}).catch(o=>r(o))})}device(e){return new Promise((t,r)=>{let i=this.cache.getKey(e.href);if(i!=null)return t(i);this.connection.read(e.href).then(o=>{this.cache.setKey(e.href,o),this.cache.save(!0),t(o)}).catch(o=>r(o))})}buttons(e){return new Promise((t,r)=>{let i=this.cache.getKey(`${e.href}/buttongroup/expanded`);if(i!=null)return t(i);this.connection.read(`${e.href}/buttongroup/expanded`).then(o=>{this.cache.setKey(`${e.href}/buttongroup/expanded`,o),this.cache.save(!0),t(o)}).catch(o=>r(o))})}update(e,t,r){return this.connection.update(`${e.href}/${t}`,r)}command(e,t){return this.connection.command(`${e.href}/commandprocessor`,{Command:t})}subscribe(e,t){return this.connection.subscribe(e.href,t)}startHeartbeat(){this.stopHeartbeat(),this.ping().finally(()=>{this.heartbeatTimeout=setTimeout(()=>this.startHeartbeat(),At)})}stopHeartbeat(){clearTimeout(this.heartbeatTimeout),this.heartbeatTimeout=void 0}};var v=require("@mkellsy/hap-device");var Ke=p(require("deep-equal")),Ue=require("@mkellsy/hap-device");var Le=require("js-logger"),Me=require("@mkellsy/hap-device"),Ne=p(require("colors")),Ie=require("@mkellsy/event-emitter"),h=class extends Ie.EventEmitter{constructor(e,t,r,i,o){super();this.initialized=!1;this.fields=new Map;this.processor=t,this.deviceAddress=i.href,this.deviceName=i.Name,this.deviceArea=r,this.deviceType=e,this.logger=(0,Le.get)(`Device ${Ne.default.dim(this.id)}`),this.state=o}get manufacturer(){return"Lutron Electronics Co., Inc"}get id(){var e;return`LEAP-${this.processor.id}-${Me.DeviceType[this.deviceType].toUpperCase()}-${(e=this.deviceAddress)==null?void 0:e.split("/")[2]}`}get name(){return this.deviceName}get room(){return this.area.Name}get capabilities(){return Object.fromEntries(this.fields)}get log(){return this.logger}get address(){return{href:this.deviceAddress}}get type(){return this.deviceType}get area(){return this.deviceArea}get status(){return this.state}};var _=class extends h{constructor(s,e,t){super(Ue.DeviceType.Contact,s,e,t,{state:"Open"}),this.fields.set("state",{type:"String",values:["Open","Closed"]})}update(s){let e=d({},this.status);s.CCOLevel!=null&&(this.state.state=s.CCOLevel),this.initialized&&!(0,Ke.default)(this.state,e)&&this.emit("Update",this,this.state),this.initialized=!0}set(s){return this.processor.command(this.address,{CommandType:"GoToCCOLevel",CCOLevelParameters:{CCOLevel:s.state}})}};var $e=p(require("deep-equal")),Ze=require("@mkellsy/hap-device");var G=class extends h{constructor(s,e,t){super(Ze.DeviceType.Dimmer,s,e,t,{state:"Off",level:0}),this.fields.set("state",{type:"String",values:["On","Off"]}),this.fields.set("level",{type:"Integer",min:0,max:100})}update(s){let e=d({},this.status);s.Level!=null&&(this.state.state=s.Level>0?"On":"Off",this.state.level=s.Level),this.initialized&&!(0,$e.default)(this.state,e)&&this.emit("Update",this,this.state),this.initialized=!0}set(s){return this.processor.command(this.address,{CommandType:"GoToLevel",Parameter:[{Type:"Level",Value:s.state==="Off"?0:s.level}]})}};var qe=p(require("deep-equal")),He=require("@mkellsy/hap-device");var j=class extends h{constructor(s,e,t){super(He.DeviceType.Fan,s,e,t,{state:"Off",speed:0}),this.fields.set("state",{type:"String",values:["On","Off"]}),this.fields.set("speed",{type:"Integer",min:0,max:7})}update(s){let e=d({},this.status),t=this.parseFanSpeed(s.FanSpeed);this.state=P(d({},e),{state:t>0?"On":"Off",speed:t}),this.initialized&&!(0,qe.default)(this.state,e)&&this.emit("Update",this,this.state),this.initialized=!0}set(s){let e=s.state==="Off"?"Off":this.lookupFanSpeed(s.speed);return this.processor.command(this.address,{CommandType:"GoToFanSpeed",FanSpeedParameters:[{FanSpeed:e}]})}lookupFanSpeed(s){switch(s){case 1:return"Low";case 2:case 3:return"Medium";case 4:case 5:return"MediumHigh";case 6:case 7:return"High";default:return"Off"}}parseFanSpeed(s){switch(s){case"Low":return 1;case"Medium":return 3;case"MediumHigh":return 5;case"High":return 7;default:return 0}}};var T=p(require("colors")),Fe=require("@mkellsy/hap-device");var br=require("@mkellsy/hap-device");var S=require("@mkellsy/hap-device"),ze=require("@mkellsy/event-emitter");var k=class extends ze.EventEmitter{constructor(e,t,r,i){super();this.state=S.TriggerState.Idle;this.index=r,this.processor=e,this.action=t,this.options=d({doubleClickSpeed:300,clickSpeed:450,raiseLower:!1,triggerOn:"pressAndRelease"},i),this.button={id:this.id,index:this.index,name:((this.action.Engraving||{}).Text||this.action.Name).replace(/\n/g," ")},this.options.raiseLower===!0&&(this.button.raiseLower=!0)}get id(){return`LEAP-${this.processor.id}-BUTTON-${this.action.href.split("/")[2]}`}get definition(){return this.button}reset(){this.state=S.TriggerState.Idle,this.timer&&clearTimeout(this.timer),this.timer=void 0}update(e){let t=()=>{this.reset(),this.options.clickSpeed!==0&&this.emit("LongPress",this.button)},r=()=>{this.reset(),this.emit("Press",this.button)};if(this.options.triggerOn==="press"){if(e.ButtonEvent.EventType==="Press"){if(this.state===S.TriggerState.Idle)this.state=S.TriggerState.Up,this.options.doubleClickSpeed>0?this.timer=setTimeout(r,this.options.doubleClickSpeed):r();else if(this.state===S.TriggerState.Up&&this.timer){if(this.reset(),this.options.doubleClickSpeed===0)return;this.emit("DoublePress",this.button)}}else e.ButtonEvent.EventType==="LongHold"&&(this.reset(),this.emit("LongPress",this.button));return}if(this.options.triggerOn==="release"){if(e.ButtonEvent.EventType==="Release"){if(this.state===S.TriggerState.Idle)this.state=S.TriggerState.Up,this.options.doubleClickSpeed>0?this.timer=setTimeout(r,this.options.doubleClickSpeed):r();else if(this.state===S.TriggerState.Up&&this.timer){if(this.reset(),this.options.doubleClickSpeed===0)return;this.emit("DoublePress",this.button)}}else e.ButtonEvent.EventType==="LongHold"&&(this.reset(),this.emit("LongPress",this.button));return}switch(this.state){case S.TriggerState.Idle:{if(e.ButtonEvent.EventType==="Press"&&this.options.clickSpeed>0){this.state=S.TriggerState.Down,this.timer=setTimeout(t,this.options.clickSpeed);return}if(e.ButtonEvent.EventType==="Press"){this.state=S.TriggerState.Down,r();return}break}case S.TriggerState.Down:{if(e.ButtonEvent.EventType==="Release"){this.state=S.TriggerState.Up,this.timer&&clearTimeout(this.timer),this.options.doubleClickSpeed>0&&(this.timer=setTimeout(r,this.options.doubleClickSpeed+(this.options.raiseLower?250:0)));return}this.reset();break}case S.TriggerState.Up:{if(e.ButtonEvent.EventType==="Press"&&this.timer){if(this.reset(),this.options.doubleClickSpeed===0)return;this.emit("DoublePress",this.button);return}this.reset();break}}}};var W=class extends h{constructor(e,t,r,i){super(Fe.DeviceType.Keypad,e,t,r,{led:{href:"/unknown"},state:"Off"});this.buttons=[];this.triggers=[];this.config=i||{},r.DeviceType==="SunnataKeypad"||r.DeviceType==="SunnataHybridKeypad"||r.DeviceType==="PalladiomKeypad"?(this.log.info(T.default.cyan(`KeypadController: Initializing ${r.DeviceType} at ${this.address.href}`)),this.initPromise=this.processor.buttons(this.address).then(o=>{var c,a,l;this.log.info(T.default.cyan(`KeypadController: Retrieved ${(o==null?void 0:o.length)||0} button groups`));for(let y=0;y<(o==null?void 0:o.length);y++)for(let u=0;u<((c=o[y].Buttons)==null?void 0:c.length);u++){let m=o[y].Buttons[u],f=(a=m.ProgrammingModel)==null?void 0:a.ProgrammingModelType,g=((m.Engraving||{}).Text||m.Name).replace(/\n/g," ");console.error(`[KEYPAD_INIT] Button: "${g}", Type: ${f||"undefined"}, Index: ${m.ButtonNumber}`);let se=(l=this.config.buttonConfig)==null?void 0:l[g],dt=(se==null?void 0:se.triggerOn)||"release";this.setupTriggerButton(m,m.ButtonNumber,{triggerOn:dt,doubleClickSpeed:500,clickSpeed:0})}this.log.info(T.default.green(`KeypadController: Successfully initialized ${this.buttons.length} buttons with TriggerController (default: release mode)`))}).catch(o=>{this.log.error(T.default.red(`KeypadController: Error fetching buttons for ${r.DeviceType}: ${o.message}`)),this.log.error(T.default.red(o.stack||"No stack trace"))})):this.initPromise=Promise.resolve()}initialize(){return this.initPromise||Promise.resolve()}setupTriggerButton(e,t,r){let i=new k(this.processor,e,t,r);this.triggers.push(i),this.buttons.push(i.definition);let o=r.triggerOn||"pressAndRelease";console.error(`[TRIGGER_SETUP] Button: "${i.definition.name}", ID: ${i.definition.id}, Mode: ${o}, Index: ${t}`),this.processor.subscribe({href:`${e.href}/status/event`},c=>{let a=c.ButtonEvent.EventType;console.error(`[TRIGGER_EVENT] "${e.Name.replace(/\n/g," ")}" received: ${a} (triggerMode: ${o})`),i.update(c)}).catch(c=>this.log.error(T.default.red(c.message))),i.on("Press",c=>{console.error(`[TRIGGER_ACTION] "${c.name}" -> Press`),this.emit("Action",this,c,"Press")}),i.on("DoublePress",c=>{console.error(`[TRIGGER_ACTION] "${c.name}" -> DoublePress`),this.emit("Action",this,c,"DoublePress")}),i.on("LongPress",c=>{console.error(`[TRIGGER_ACTION] "${c.name}" -> LongPress`),this.emit("Action",this,c,"LongPress")})}update(){this.initialized=!0}set(e){return this.processor.update(e.led,"status",{LEDStatus:{State:e.state==="On"?"On":"Off"}})}};var ae=p(require("colors")),Ge=require("@mkellsy/hap-device");var _e=new Map([["Pico2Button",new Map([[0,[1,!1]],[2,[2,!1]]])],["Pico2ButtonRaiseLower",new Map([[0,[1,!1]],[2,[4,!1]],[3,[2,!0]],[4,[3,!0]]])],["Pico3Button",new Map([[0,[1,!1]],[1,[2,!1]],[2,[3,!1]]])],["Pico3ButtonRaiseLower",new Map([[0,[1,!1]],[1,[3,!1]],[2,[5,!1]],[3,[2,!0]],[4,[4,!0]]])],["Pico4Button2Group",new Map([[1,[1,!1]],[2,[2,!1]],[3,[3,!1]],[4,[4,!1]]])],["Pico4ButtonScene",new Map([[1,[1,!1]],[2,[2,!1]],[3,[3,!1]],[4,[4,!1]]])],["Pico4ButtonZone",new Map([[1,[1,!1]],[2,[2,!1]],[3,[3,!1]],[4,[4,!1]]])],["PaddleSwitchPico",new Map([[0,[1,!1]],[2,[2,!1]]])],["Pico4Button",new Map([[1,[1,!1]],[2,[2,!1]],[3,[3,!1]],[4,[4,!1]]])]]);var J=class extends h{constructor(e,t,r){super(Ge.DeviceType.Remote,e,t,r,{state:"Unknown"});this.buttons=[];this.triggers=new Map;this.set=()=>Promise.resolve();this.initPromise=this.processor.buttons(this.address).then(i=>{var o;for(let c=0;c<(i==null?void 0:i.length);c++)for(let a=0;a<((o=i[c].Buttons)==null?void 0:o.length);a++){let l=i[c].Buttons[a],y=_e.get(r.DeviceType),u=y.get(l.ButtonNumber)[0],m=y.get(l.ButtonNumber)[1],f=new k(this.processor,l,u,{raiseLower:m});f.on("Press",g=>{this.emit("Action",this,g,"Press"),setTimeout(()=>this.emit("Action",this,g,"Release"),100)}),f.on("DoublePress",g=>{this.emit("Action",this,g,"DoublePress"),setTimeout(()=>this.emit("Action",this,g,"Release"),100)}),f.on("LongPress",g=>{this.emit("Action",this,g,"LongPress"),setTimeout(()=>this.emit("Action",this,g,"Release"),100)}),this.triggers.set(l.href,f),this.buttons.push(f.definition),this.processor.subscribe({href:`${l.href}/status/event`},g=>this.triggers.get(l.href).update(g)).catch(g=>this.log.error(ae.default.red(g.message)))}}).catch(i=>this.log.error(ae.default.red(i.message)))}initialize(){return this.initPromise||Promise.resolve()}update(){this.initialized=!0}};var je=p(require("deep-equal")),We=require("@mkellsy/hap-device");var V=class extends h{constructor(e,t,r){super(We.DeviceType.Occupancy,e,t,r,{state:"Unoccupied"});this.set=()=>Promise.resolve()}update(e){let t=d({},this.status);e.OccupancyStatus!=null&&(this.state.state=e.OccupancyStatus==="Occupied"?"Occupied":"Unoccupied"),(0,je.default)(this.state,t)||this.emit("Update",this,this.state),this.initialized=!0}};var Je=p(require("deep-equal")),Ve=require("@mkellsy/hap-device");var Y=class extends h{constructor(s,e,t){super(Ve.DeviceType.Shade,s,e,t,{state:"Closed",level:0,tilt:0}),this.fields.set("state",{type:"String",values:["Open","Closed"]}),this.fields.set("level",{type:"Integer",min:0,max:100}),this.fields.set("tilt",{type:"Integer",min:0,max:100})}update(s){let e=d({},this.status);s.Level!=null&&(this.state.state=s.Level>0?"Open":"Closed",this.state.level=s.Level),s.Tilt!=null&&(this.state.tilt=s.Tilt),this.initialized&&!(0,Je.default)(this.state,e)&&this.emit("Update",this,this.state),this.initialized=!0}set(s){let e=[];return e.push(this.processor.command(this.address,{CommandType:"GoToLevel",Parameter:[{Type:"Level",Value:s.state==="Closed"?0:s.level}]})),(s.tilt!=null||s.state==="Closed")&&e.push(this.processor.command(this.address,{CommandType:"TiltParameters",TiltParameters:{Tilt:s.state==="Closed"?0:s.tilt}})),Promise.all(e)}};var Ye=p(require("deep-equal")),Qe=require("@mkellsy/hap-device");var Q=class extends h{constructor(s,e,t){super(Qe.DeviceType.Strip,s,e,t,{state:"Off",level:0,luminance:1800}),this.fields.set("state",{type:"String",values:["On","Off"]}),this.fields.set("level",{type:"Integer",min:0,max:100}),this.fields.set("luminance",{type:"Integer",min:1800,max:3e3})}update(s){let e=d({},this.status);s.Level!=null&&(this.state.state=s.Level>0?"On":"Off",this.state.level=s.Level),s.ColorTuningStatus!=null&&s.ColorTuningStatus.WhiteTuningLevel!=null&&s.ColorTuningStatus.WhiteTuningLevel.Kelvin!=null&&(this.state.luminance=s.ColorTuningStatus.WhiteTuningLevel.Kelvin),this.initialized&&!(0,Ye.default)(this.state,e)&&this.emit("Update",this,this.state),this.initialized=!0}set(s){return s.state==="Off"?this.processor.command(this.address,{CommandType:"GoToWhiteTuningLevel",WhiteTuningLevelParameters:{Level:0}}):this.processor.command(this.address,{CommandType:"GoToWhiteTuningLevel",WhiteTuningLevelParameters:{Level:s.level,WhiteTuningLevel:{Kelvin:s.luminance}}})}};var Xe=p(require("deep-equal")),et=require("@mkellsy/hap-device");var X=class extends h{constructor(s,e,t){super(et.DeviceType.Switch,s,e,t,{state:"Off"}),this.fields.set("state",{type:"String",values:["On","Off"]})}update(s){let e=d({},this.status);this.state=P(d({},e),{state:s.SwitchedLevel||"Unknown"}),this.initialized&&!(0,Xe.default)(this.state,e)&&this.emit("Update",this,this.state),this.initialized=!0}set(s){return this.processor.command(this.address,{CommandType:"GoToLevel",Parameter:[{Type:"Level",Value:s.state==="On"?100:0}]})}};var tt=p(require("deep-equal")),rt=require("@mkellsy/hap-device");var ee=class extends h{constructor(e,t,r){super(rt.DeviceType.Timeclock,e,t,r,{state:"Off"});this.set=()=>Promise.resolve();this.fields.set("state",{type:"String",values:["On","Off"]})}update(e){let t=d({},this.status);this.state=P(d({},t),{state:e.EnabledState==="Enabled"?"On":"Off"}),this.initialized&&!(0,tt.default)(this.state,t)&&this.emit("Update",this,this.state),this.initialized=!0}};var st=require("@mkellsy/hap-device");var te=class extends h{constructor(e,t,r){super(st.DeviceType.Unknown,e,t,r,{state:"Unknown"});this.set=()=>Promise.resolve()}update(){}};function re(n,s,e,t){var i;switch(de(e.ControlType||e.DeviceType)){case v.DeviceType.Contact:return new _(n,s,e);case v.DeviceType.Dimmer:return new G(n,s,e);case v.DeviceType.Fan:return new j(n,s,e);case v.DeviceType.Keypad:return new W(n,s,e,t);case v.DeviceType.Occupancy:return new V(n,s,{href:`/occupancy/${(i=s.href)==null?void 0:i.split("/")[2]}`,Name:e.Name});case v.DeviceType.Remote:return new J(n,s,e);case v.DeviceType.Shade:return new Y(n,s,e);case v.DeviceType.Strip:return new Q(n,s,e);case v.DeviceType.Switch:return new X(n,s,e);case v.DeviceType.Timeclock:return new ee(n,s,e);default:return new te(n,s,e)}}function de(n){switch(n){case"Switched":case"PowPakSwitch":case"OutdoorPlugInSwitch":return v.DeviceType.Switch;case"Dimmed":case"PlugInDimmer":return v.DeviceType.Dimmer;case"Shade":return v.DeviceType.Shade;case"Timeclock":return v.DeviceType.Timeclock;case"WhiteTune":return v.DeviceType.Strip;case"FanSpeed":return v.DeviceType.Fan;case"Pico2Button":case"Pico3Button":case"Pico4Button":case"Pico3ButtonRaiseLower":return v.DeviceType.Remote;case"SunnataDimmer":case"SunnataSwitch":case"SunnataKeypad":case"SunnataHybridKeypad":case"PalladiomKeypad":return v.DeviceType.Keypad;case"RPSCeilingMountedOccupancySensor":return v.DeviceType.Occupancy;case"CCO":return v.DeviceType.Contact;default:return v.DeviceType.Unknown}}function it(n){if(n.AddressedState!=="Addressed")return!1;switch(n.DeviceType){case"Pico2Button":case"Pico3Button":case"Pico4Button":case"Pico3ButtonRaiseLower":return!0;case"SunnataKeypad":case"SunnataHybridKeypad":case"PalladiomKeypad":return!0;case"RPSCeilingMountedOccupancySensor":return!0;default:return!1}}var ot=(0,ct.get)("Client"),nt=5e3,M=class extends at.EventEmitter{constructor(e,t){super(1/0);this.discovered=new Map;this.onDiscovered=e=>{if(this.discovered.delete(e.id),!this.context.has(e.id))return;let t=e.addresses.find(i=>i.family===B.HostAddressFamily.IPv4)||e.addresses[0],r=new F(e.id,new C(t.address,this.context.get(e.id)));this.discovered.set(e.id,r),r.log.info(`Processor ${R.default.green(t.address)}`),r.on("Disconnect",()=>{setTimeout(()=>this.onDiscovered(e),nt)}).on("Connect",()=>{this.refresh&&r.clear(),Promise.all([r.system(),r.project(),r.areas()]).then(([i,o,c])=>{let a=i==null?void 0:i.FirmwareImage.Firmware.DisplayName,l=i==null?void 0:i.DeviceType,y=[];r.log.info(`Firmware ${R.default.green(a||"Unknown")}`),r.log.info(o.ProductType),r.subscribe({href:"/zone/status"},u=>{for(let m of u){let f=r.devices.get(m.Zone.href);f!=null&&f.update(m)}}).catch(u=>this.onProcessorError(e,u)),r.subscribe({href:"/area/status"},u=>{var m;for(let f of u){let g=r.devices.get(`/occupancy/${(m=f.href)==null?void 0:m.split("/")[2]}`);g!=null&&f.OccupancyStatus!=null&&g.update(f)}}).catch(u=>this.onProcessorError(e,u)),l==="RadioRa3Processor"&&r.subscribe({href:"/timeclock/status"},u=>{for(let m of u){let f=r.devices.get(m.Timeclock.href);f!=null&&f.update(m)}}).catch(u=>this.onProcessorError(e,u));for(let u of c)y.push(new Promise(m=>{this.discoverZones(r,u).then(()=>m())})),y.push(new Promise(m=>{this.discoverControls(r,u).then(()=>m())}));l==="RadioRa3Processor"&&y.push(new Promise(u=>{this.discoverTimeclocks(r).then(()=>u())})),Promise.all(y).then(()=>{r.statuses(l).then(u=>{for(let m of u){let f=r.devices.get((m.Zone||{}).href||""),g=r.devices.get(`/occupancy/${(m.href||"").split("/")[2]}`);f!=null&&f.update(m),g!=null&&m.OccupancyStatus!=null&&g.update(m)}}),r.log.info(`discovered ${R.default.green([...r.devices.keys()].length.toString())} devices`),this.emit("Available",[...r.devices.values()])})}).catch(i=>this.onProcessorError(e,i))}).on("Error",i=>this.onProcessorError(e,i)),r.connect().catch(i=>this.onProcessorError(e,i))};this.onDeviceUpdate=(e,t)=>{this.emit("Update",e,t)};this.onDeviceAction=(e,t,r)=>{this.emit("Action",e,t,r)};this.onProcessorError=(e,t)=>{if(t.message==null){ot.error(R.default.red(String(t)));return}if(t.message.match(/ENOTFOUND|ENETUNREACH|EHOSTUNREACH|ECONNRESET|EPIPE|ECONNREFUSED|ETIMEDOUT/g)!=null){setTimeout(()=>this.onDiscovered(e),nt);return}ot.error(R.default.red(t.message))};this.context=new D,this.discovery=new E,this.refresh=e===!0,this.config=t||{},this.discovery.on("Discovered",this.onDiscovered).search()}get processors(){return[...this.discovered.keys()]}processor(e){return this.discovered.get(e)}close(){this.discovery.stop();for(let e of this.discovered.values())e.disconnect();this.discovered.clear()}discoverZones(e,t){return new Promise(r=>{if(!t.IsLeaf)return r();e.zones(t).then(i=>{for(let o of i){let c=re(e,t,P(d({},o),{Name:`${t.Name} ${o.Name}`}),this.config).on("Update",this.onDeviceUpdate).on("Action",this.onDeviceAction);e.devices.set(o.href,c)}r()}).catch(()=>r())})}discoverTimeclocks(e){return new Promise(t=>{e.timeclocks().then(r=>{for(let i of r){let o=re(e,{href:i.href,Name:i.Name,ControlType:"Timeclock",Parent:i.Parent,IsLeaf:!0,AssociatedZones:[],AssociatedControlStations:[],AssociatedOccupancyGroups:[]},P(d({},i),{ControlType:"Timeclock"}),this.config).on("Update",this.onDeviceUpdate);e.devices.set(i.href,o)}t()}).catch(()=>t())})}discoverControls(e,t){return new Promise(r=>{if(!t.IsLeaf)return r();e.controls(t).then(i=>N(this,null,function*(){var o;for(let c of i){let a=yield this.discoverPositions(e,c),l=[];for(let y of a){let u=de(y.DeviceType),m=u===B.DeviceType.Occupancy?`/occupancy/${(o=t.href)==null?void 0:o.split("/")[2]}`:y.href,f=re(e,t,P(d({},y),{Name:`${t.Name} ${c.Name} ${y.Name}`}),this.config).on("Update",this.onDeviceUpdate).on("Action",this.onDeviceAction);e.devices.set(m,f),(u===B.DeviceType.Keypad||u===B.DeviceType.Remote)&&l.push(f.initialize())}yield Promise.all(l)}r()})).catch(()=>r())})}discoverPositions(e,t){return new Promise(r=>{if(t.AssociatedGangedDevices==null)return r([]);let i=[];for(let o of t.AssociatedGangedDevices)i.push(e.device(o.Device));Promise.all(i).then(o=>{r(o.filter(c=>it(c)))}).catch(()=>r([]))})}};function Ct(n,s){return new M(n,s)}function wt(){return new Promise((n,s)=>{let e=new E,t=new D;e.on("Discovered",r=>{t.get(r.id)==null&&new H(r).authenticate().then(o=>{t.set(r,o),n()}).catch(o=>s(o)).finally(()=>e.stop())}),e.search()})}0&&(module.exports={Client,connect,pair});
//# sourceMappingURL=index.js.map
