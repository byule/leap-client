var lt=Object.create;var x=Object.defineProperty,ht=Object.defineProperties,ft=Object.getOwnPropertyDescriptor,vt=Object.getOwnPropertyDescriptors,gt=Object.getOwnPropertyNames,pe=Object.getOwnPropertySymbols,yt=Object.getPrototypeOf,he=Object.prototype.hasOwnProperty,St=Object.prototype.propertyIsEnumerable;var le=(n,r,e)=>r in n?x(n,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[r]=e,m=(n,r)=>{for(var e in r||(r={}))he.call(r,e)&&le(n,e,r[e]);if(pe)for(var e of pe(r))St.call(r,e)&&le(n,e,r[e]);return n},P=(n,r)=>ht(n,vt(r));var Pt=(n,r)=>{for(var e in r)x(n,e,{get:r[e],enumerable:!0})},fe=(n,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of gt(r))!he.call(n,s)&&s!==e&&x(n,s,{get:()=>r[s],enumerable:!(t=ft(r,s))||t.enumerable});return n};var l=(n,r,e)=>(e=n!=null?lt(yt(n)):{},fe(r||!n||!n.__esModule?x(e,"default",{value:n,enumerable:!0}):e,n)),bt=n=>fe(x({},"__esModule",{value:!0}),n);var ve=(n,r,e)=>new Promise((t,s)=>{var i=a=>{try{c(e.next(a))}catch(u){s(u)}},o=a=>{try{c(e.throw(a))}catch(u){s(u)}},c=a=>a.done?t(a.value):Promise.resolve(a.value).then(i,o);c((e=e.apply(n,r)).next())});var Bt={};Pt(Bt,{Client:()=>M,connect:()=>Et,pair:()=>kt});module.exports=bt(Bt);var I=require("node-forge"),we=require("@mkellsy/hap-device");var ie=l(require("fs")),Pe=l(require("path")),be=l(require("net")),Ae=require("bson"),Te=require("node-forge"),L=require("uuid");var ge=require("@mkellsy/event-emitter");var N=class{};var Z=class n{constructor(r,e){this.message=r,this.code=e}static fromString(r){let e=r==null?void 0:r.split(" ",2);if(e==null||e.length===1)return new n(r);let t=parseInt(e[0],10);return Number.isNaN(t)?new n(r):new n(e[1],t)}isSuccessful(){return this.code!==void 0&&this.code>=200&&this.code<300}};var w=class n{constructor(){this.Header=new N}static parse(r){let e=JSON.parse(r),t=e.Header.StatusCode==null?void 0:Z.fromString(e.Header.StatusCode),s=Object.assign({},e.Header,{StatusCode:t,MessageBodyType:e.Header.MessageBodyType});if(s.MessageBodyType==null)return Object.assign(new n,{Header:s});let i=Object.keys(e.Body||{})[0],o=i!=null&&e.Body[i]||void 0;return Object.assign(new n,e,{Header:s,Body:o})}};var K=class extends ge.EventEmitter{constructor(){super(...arguments);this.buffer=""}parse(e,t){let s=this.buffer+e.toString(),i=s.split(/\r?\n/);if(i.length-1===0){this.buffer=s;return}this.buffer=i[i.length-1]||"";for(let o of i.slice(0,i.length-1))t(w.parse(o))}};var O=class{constructor(){this.Message=""}};var ye=require("@mkellsy/event-emitter"),q=require("tls"),At=1e4,Tt=3e4,U=class extends ye.EventEmitter{constructor(e,t,s){super();this.onSocketData=e=>{this.emit("Data",e)};this.onSocketTimeout=()=>{this.emit("Error",new Error("connect ETIMEDOUT"))};this.onSocketClose=()=>{this.emit("Disconnect")};this.onSocketError=e=>{this.emit("Error",e)};this.host=e,this.port=t,this.certificate=s}connect(){return new Promise((e,t)=>{let s=(0,q.connect)(this.port,this.host,{secureContext:(0,q.createSecureContext)(this.certificate),secureProtocol:"TLS_method",rejectUnauthorized:!1});s.once("secureConnect",()=>{this.connection=s,this.connection.off("error",t),this.connection.on("timeout",this.onSocketTimeout),this.connection.on("error",this.onSocketError),this.connection.on("close",this.onSocketClose),this.connection.on("data",this.onSocketData),this.connection.setKeepAlive(!0,At),this.connection.setTimeout(Tt),e(this.connection.getProtocol()||"Unknown")}),s.once("error",t)})}disconnect(){var e,t;(e=this.connection)==null||e.end(),(t=this.connection)==null||t.destroy()}write(e){return new Promise((t,s)=>{if(this.connection==null)return s(new Error("connection not established"));this.connection.write(`${JSON.stringify(e)}
`,i=>i!=null?s(i):t())})}};var Se=8083,wt=8081,Ct=1e3,C=class extends K{constructor(e,t){super();this.secure=!1;this.teardown=!1;this.requests=new Map;this.subscriptions=new Map;this.onResponse=e=>{let t=e.Header.ClientTag;if(t==null){this.emit("Message",e);return}let s=this.requests.get(t);s!=null&&(clearTimeout(s.timeout),this.requests.delete(t),s.resolve(e));let i=this.subscriptions.get(t);i!=null&&i.callback(e)};this.onSocketData=e=>{this.secure?this.parse(e,this.onResponse):this.emit("Message",JSON.parse(e.toString()))};this.onSocketDisconnect=()=>{this.teardown||this.emit("Disconnect")};this.onSocketError=e=>{this.emit("Error",e)};this.host=e,this.secure=t!=null,this.certificate=m({ca:"",cert:"",key:""},t!=null?t:this.authorityCertificate())}static reachable(e){return new Promise(t=>{let s=new be.default.Socket,i=o=>{s.destroy(),t(o)};s.setTimeout(Ct),s.once("error",()=>i(!1)),s.once("timeout",()=>i(!1)),s.connect(Se,e,()=>i(!0))})}connect(){return new Promise((e,t)=>{this.teardown=!1,this.socket=void 0;let s=[...this.subscriptions.values()],i=new U(this.host,this.secure?wt:Se,this.certificate);i.on("Data",this.onSocketData),i.on("Error",this.onSocketError),i.on("Disconnect",this.onSocketDisconnect),i.connect().then(o=>{this.physicalAccess(this.secure).then(()=>{let c=[];if(this.subscriptions.clear(),this.socket=i,this.secure)for(let a of s)c.push(this.subscribe(a.url,a.listener));Promise.all(c).then(()=>{this.emit("Connect",o),e()})})}).catch(o=>t(o))})}disconnect(){var e;this.teardown=!0,this.secure&&this.drainRequests(),this.subscriptions.clear(),(e=this.socket)==null||e.disconnect()}read(e){return new Promise((t,s)=>{let i=(0,L.v4)();if(!this.secure)return s(new Error("Only available for secure connections"));this.sendRequest(i,"ReadRequest",e).then(o=>o.Body==null?s(new Error(`${e} no body`)):o.Body instanceof O?s(new Error(o.Body.Message)):t(o.Body)).catch(o=>s(o))})}authenticate(e){return new Promise((t,s)=>{var c;if(this.secure)return s(new Error("Only available for physical connections"));let i={Header:{RequestType:"Execute",Url:"/pair",ClientTag:"get-cert"},Body:{CommandType:"CSR",Parameters:{CSR:e.cert,DisplayName:"get_lutron_cert.py",DeviceUID:"000000000000",Role:"Admin"}}},o=setTimeout(()=>s(new Error("Authentication timeout exceeded")),5e3);this.once("Message",a=>{clearTimeout(o),t({ca:a.Body.SigningResult.RootCertificate,cert:a.Body.SigningResult.Certificate,key:Te.pki.privateKeyToPem(e.key)})}),(c=this.socket)==null||c.write(i)})}update(e,t){return new Promise((s,i)=>{let o=(0,L.v4)();if(!this.secure)return i(new Error("Only available for secure connections"));this.sendRequest(o,"UpdateRequest",e,t).then(c=>c.Body instanceof O?i(new Error(c.Body.Message)):s(c.Body)).catch(c=>i(c))})}command(e,t){return new Promise((s,i)=>{let o=(0,L.v4)();if(!this.secure)return i(new Error("Only available for secure connections"));this.sendRequest(o,"CreateRequest",e,t).then(()=>s()).catch(c=>i(c))})}subscribe(e,t){return new Promise((s,i)=>{if(!this.secure)return i(new Error("Only available for secure connections"));let o=(0,L.v4)();this.sendRequest(o,"SubscribeRequest",e).then(c=>{c.Header.StatusCode!=null&&c.Header.StatusCode.isSuccessful()&&this.subscriptions.set(o,{url:e,listener:t,callback:a=>t(a.Body)}),s()}).catch(c=>i(c))})}drainRequests(){for(let e of this.requests.keys()){let t=this.requests.get(e);clearTimeout(t.timeout)}this.requests.clear()}sendRequest(e,t,s,i){return new Promise((o,c)=>{if(this.requests.has(e)){let u=this.requests.get(e);u.reject(new Error(`tag "${e}" reused`)),clearTimeout(u.timeout),this.requests.delete(e)}let a={CommuniqueType:t,Header:{ClientTag:e,Url:s},Body:i};if(this.socket==null)return c(new Error("Connection not established"));this.socket.write(a).then(()=>{this.requests.set(e,{message:a,resolve:o,reject:c,timeout:setTimeout(()=>o(w.parse(JSON.stringify({Header:{MessageBodyType:"ExceptionDetail"},Body:{Message:"Request timeout"}}))),5e3)})}).catch(u=>c(u))})}authorityCertificate(){let e=Pe.default.resolve(__dirname,"../authority");if(ie.default.existsSync(e)){let t=ie.default.readFileSync(e);if(t==null)return null;let s=Ae.BSON.deserialize(t);return s.ca=Buffer.from(s.ca,"base64").toString("utf8"),s.key=Buffer.from(s.key,"base64").toString("utf8"),s.cert=Buffer.from(s.cert,"base64").toString("utf8"),s}return null}physicalAccess(e){return new Promise((t,s)=>{if(e)return t();let i=setTimeout(()=>s(new Error("Physical timeout exceeded")),6e4);this.once("Message",o=>o.Body.Status.Permissions.includes("PhysicalAccess")?(clearTimeout(i),t()):s(new Error("Unknown pairing error")))})}};var $=class{constructor(r){let e=r.addresses.find(t=>t.family===we.HostAddressFamily.IPv4)||r.addresses[0];this.connection=new C(e.address)}authenticate(){return ve(this,null,function*(){return new Promise((r,e)=>{this.connection.connect().then(()=>{this.createCertificateRequest("mkellsy-mqtt-lutron").then(t=>{this.connection.authenticate(t).then(s=>r(s)).catch(s=>e(s))}).catch(t=>e(t))}).catch(t=>e(t))})})}createCertificateRequest(r){return new Promise((e,t)=>{I.pki.rsa.generateKeyPair({bits:2048},(s,i)=>{if(s==null){let o=I.pki.createCertificationRequest();return o.publicKey=i.publicKey,o.setSubject([{name:"commonName",value:r}]),o.sign(i.privateKey),e({key:i.privateKey,cert:I.pki.certificationRequestToPem(o)})}return t(new Error("Error generating RSA keys"))})})}};var T=l(require("fs")),D=l(require("path")),oe=l(require("os")),ne=require("bson");var E=class{constructor(){this.context={};let r=this.open("pairing")||{},e=Object.keys(r);for(let t=0;t<e.length;t++)r[e[t]]=this.decrypt(r[e[t]]);this.context=r}get processors(){return Object.keys(this.context).filter(r=>r!=="authority")}has(r){return this.context[r]!=null}get(r){return this.context[r]}set(r,e){this.context[r.id]=m({},e),this.save("pairing",this.context)}decrypt(r){return r==null?null:(r.ca=Buffer.from(r.ca,"base64").toString("utf8"),r.key=Buffer.from(r.key,"base64").toString("utf8"),r.cert=Buffer.from(r.cert,"base64").toString("utf8"),r)}encrypt(r){return r==null?null:(r.ca=Buffer.from(r.ca).toString("base64"),r.key=Buffer.from(r.key).toString("base64"),r.cert=Buffer.from(r.cert).toString("base64"),r)}open(r){let e=D.default.join(oe.default.homedir(),".leap");if(T.default.existsSync(e)||T.default.mkdirSync(e),T.default.existsSync(D.default.join(e,r))){let t=T.default.readFileSync(D.default.join(e,r));return ne.BSON.deserialize(t)}return null}save(r,e){let t=D.default.join(oe.default.homedir(),".leap");T.default.existsSync(t)||T.default.mkdirSync(t);let s=m({},e),i=Object.keys(s);for(let o=0;o<i.length;o++)s[i[o]]=this.encrypt(s[i[o]]);T.default.writeFileSync(D.default.join(t,r),ne.BSON.serialize(s))}};var Ce=l(require("os")),De=l(require("path")),Ee=l(require("deep-equal")),ke=l(require("flat-cache")),Be=require("@mkellsy/event-emitter"),H=require("tinkerhub-mdns"),ce=require("@mkellsy/hap-device"),k=class extends Be.EventEmitter{constructor(){super();this.onAvailable=e=>{if(!this.isProcessorService(e))return;let t=this.parseProcessorAddress(e);this.isProcessorCached(t)||this.emit("Discovered",t),this.cacheProcessor(t)};this.cache=ke.default.load("discovery",De.default.join(Ce.default.homedir(),".leap")),this.cached=this.cache.getKey("/hosts")||[],this.cache.setKey("/hosts",this.cached),this.cache.save(!0)}search(){this.stop();for(let e=0;e<this.cached.length;e++)this.emit("Discovered",this.cached[e]);this.discovery=new H.MDNSServiceDiscovery({type:"lutron",protocol:H.Protocol.TCP}),this.discovery.onAvailable(this.onAvailable)}stop(){var e;(e=this.discovery)==null||e.destroy()}isProcessorCached(e){return this.cached.find(t=>(0,Ee.default)(t,e))!=null}isProcessorService(e){let t=e.data.get("systype");return!(t==null||typeof t=="boolean")}cacheProcessor(e){let t=this.cached.findIndex(s=>s.id===e.id);t>=0?this.cached[t]=e:this.cached.push(e),this.cache.setKey("/hosts",this.cached),this.cache.save()}parseProcessorAddress(e){var i;let t=this.discovery.serviceData.get(e.id).SRV._record.target,s=[];for(let o=0;o<((i=e.addresses)==null?void 0:i.length);o++)s.push({address:e.addresses[o].host,family:/^([\da-f]{1,4}:){7}[\da-f]{1,4}$/i.test(e.addresses[o].host)?ce.HostAddressFamily.IPv6:ce.HostAddressFamily.IPv4});return{id:t.match(new RegExp("[Ll]utron-(?<id>\\w+)\\.local")).groups.id.toUpperCase(),type:String(e.data.get("systype")),addresses:s}}};var mt=require("js-logger"),R=l(require("colors")),se=require("@mkellsy/hap-device"),ut=require("@mkellsy/event-emitter");var Re=require("js-logger"),xe=l(require("flat-cache")),Oe=l(require("colors")),Le=l(require("os")),Me=l(require("path")),Ne=require("@mkellsy/event-emitter"),Dt=2e4,F=class extends Ne.EventEmitter{constructor(e,t){super();this.discovered=new Map;this.onConnect=()=>{this.log.info("connected"),this.emit("Connect",this.connection)};this.onMessage=e=>{this.log.debug("message"),this.emit("Message",e)};this.onDisconnect=()=>{this.log.info("disconnected"),this.emit("Disconnect")};this.onError=e=>{this.emit("Error",e)};this.uuid=e,this.logger=(0,Re.get)(`Processor ${Oe.default.dim(this.id)}`),this.connection=t,this.cache=xe.default.load(e,Me.default.join(Le.default.homedir(),".leap")),this.connection.on("Connect",this.onConnect),this.connection.on("Message",this.onMessage),this.connection.on("Error",this.onError),this.connection.once("Disconnect",this.onDisconnect)}get id(){return this.uuid}get log(){return this.logger}get devices(){return this.discovered}connect(){return new Promise((e,t)=>{this.connection.connect().then(()=>{this.startHeartbeat(),e()}).catch(s=>t(s))})}disconnect(){this.stopHeartbeat(),this.connection.disconnect()}clear(){for(let e of this.cache.keys())this.cache.removeKey(e);this.cache.removeCacheFile(),this.cache.save()}ping(){return this.read("/server/1/status/ping")}read(e){return this.connection.read(e)}project(){return new Promise((e,t)=>{let s=this.cache.getKey("/project");if(s!=null)return e(s);this.connection.read("/project").then(i=>{this.cache.setKey("/project",i),this.cache.save(!0),e(i)}).catch(i=>t(i))})}system(){return new Promise((e,t)=>{let s=this.cache.getKey("/device?where=IsThisDevice:true");if(s!=null)return e(s);this.connection.read("/device?where=IsThisDevice:true").then(i=>{if(i[0]!=null)return this.cache.setKey("/device?where=IsThisDevice:true",i[0]),this.cache.save(!0),e(i[0]);t(new Error("No system device found"))}).catch(i=>t(i))})}areas(){return new Promise((e,t)=>{let s=this.cache.getKey("/area");if(s!=null)return e(s);this.connection.read("/area").then(i=>{this.cache.setKey("/area",i),this.cache.save(!0),e(i)}).catch(i=>t(i))})}timeclocks(){return new Promise((e,t)=>{let s=this.cache.getKey("/timeclock");if(s!=null)return e(s);this.connection.read("/timeclock").then(i=>{this.cache.setKey("/timeclock",i),this.cache.save(!0),e(i)}).catch(i=>t(i))})}zones(e){return new Promise((t,s)=>{let i=this.cache.getKey(`${e.href}/associatedzone`);if(i!=null)return t(i);this.connection.read(`${e.href}/associatedzone`).then(o=>{this.cache.setKey(`${e.href}/associatedzone`,o),this.cache.save(!0),t(o)}).catch(o=>s(o))})}status(e){return this.read(`${e.href}/status`)}statuses(e){return new Promise((t,s)=>{let i=[];i.push(this.read("/zone/status")),i.push(this.read("/area/status")),e==="RadioRa3Processor"&&i.push(this.read("/timeclock/status")),Promise.all(i).then(([o,c,a])=>t([...o,...c,...a||[]])).catch(o=>s(o))})}controls(e){return new Promise((t,s)=>{let i=this.cache.getKey(`${e.href}/associatedcontrolstation`);if(i!=null)return t(i);this.connection.read(`${e.href}/associatedcontrolstation`).then(o=>{this.cache.setKey(`${e.href}/associatedcontrolstation`,o),this.cache.save(!0),t(o)}).catch(o=>s(o))})}device(e){return new Promise((t,s)=>{let i=this.cache.getKey(e.href);if(i!=null)return t(i);this.connection.read(e.href).then(o=>{this.cache.setKey(e.href,o),this.cache.save(!0),t(o)}).catch(o=>s(o))})}buttons(e){return new Promise((t,s)=>{let i=this.cache.getKey(`${e.href}/buttongroup/expanded`);if(i!=null)return t(i);this.connection.read(`${e.href}/buttongroup/expanded`).then(o=>{this.cache.setKey(`${e.href}/buttongroup/expanded`,o),this.cache.save(!0),t(o)}).catch(o=>s(o))})}update(e,t,s){return this.connection.update(`${e.href}/${t}`,s)}command(e,t){return this.connection.command(`${e.href}/commandprocessor`,{Command:t})}subscribe(e,t){return this.connection.subscribe(e.href,t)}startHeartbeat(){this.stopHeartbeat(),this.ping().finally(()=>{this.heartbeatTimeout=setTimeout(()=>this.startHeartbeat(),Dt)})}stopHeartbeat(){clearTimeout(this.heartbeatTimeout),this.heartbeatTimeout=void 0}};var y=require("@mkellsy/hap-device");var Ie=l(require("deep-equal")),$e=require("@mkellsy/hap-device");var Ze=require("js-logger"),Ke=require("@mkellsy/hap-device"),Ue=l(require("colors")),qe=require("@mkellsy/event-emitter"),v=class extends qe.EventEmitter{constructor(e,t,s,i,o){super();this.initialized=!1;this.fields=new Map;this.processor=t,this.deviceAddress=i.href,this.deviceName=i.Name,this.deviceArea=s,this.deviceType=e,this.logger=(0,Ze.get)(`Device ${Ue.default.dim(this.id)}`),this.state=o}get manufacturer(){return"Lutron Electronics Co., Inc"}get id(){var e;return`LEAP-${this.processor.id}-${Ke.DeviceType[this.deviceType].toUpperCase()}-${(e=this.deviceAddress)==null?void 0:e.split("/")[2]}`}get name(){return this.deviceName}get room(){return this.area.Name}get capabilities(){return Object.fromEntries(this.fields)}get log(){return this.logger}get address(){return{href:this.deviceAddress}}get type(){return this.deviceType}get area(){return this.deviceArea}get status(){return this.state}};var z=class extends v{constructor(r,e,t){super($e.DeviceType.Contact,r,e,t,{state:"Open"}),this.fields.set("state",{type:"String",values:["Open","Closed"]})}update(r){let e=m({},this.status);r.CCOLevel!=null&&(this.state.state=r.CCOLevel),this.initialized&&!(0,Ie.default)(this.state,e)&&this.emit("Update",this,this.state),this.initialized=!0}set(r){return this.processor.command(this.address,{CommandType:"GoToCCOLevel",CCOLevelParameters:{CCOLevel:r.state}})}};var He=l(require("deep-equal")),Fe=require("@mkellsy/hap-device");var _=class extends v{constructor(r,e,t){super(Fe.DeviceType.Dimmer,r,e,t,{state:"Off",level:0}),this.fields.set("state",{type:"String",values:["On","Off"]}),this.fields.set("level",{type:"Integer",min:0,max:100})}update(r){let e=m({},this.status);r.Level!=null&&(this.state.state=r.Level>0?"On":"Off",this.state.level=r.Level),this.initialized&&!(0,He.default)(this.state,e)&&this.emit("Update",this,this.state),this.initialized=!0}set(r){return this.processor.command(this.address,{CommandType:"GoToLevel",Parameter:[{Type:"Level",Value:r.state==="Off"?0:r.level}]})}};var ze=l(require("deep-equal")),_e=require("@mkellsy/hap-device");var j=class extends v{constructor(r,e,t){super(_e.DeviceType.Fan,r,e,t,{state:"Off",speed:0}),this.fields.set("state",{type:"String",values:["On","Off"]}),this.fields.set("speed",{type:"Integer",min:0,max:7})}update(r){let e=m({},this.status),t=this.parseFanSpeed(r.FanSpeed);this.state=P(m({},e),{state:t>0?"On":"Off",speed:t}),this.initialized&&!(0,ze.default)(this.state,e)&&this.emit("Update",this,this.state),this.initialized=!0}set(r){let e=r.state==="Off"?"Off":this.lookupFanSpeed(r.speed);return this.processor.command(this.address,{CommandType:"GoToFanSpeed",FanSpeedParameters:[{FanSpeed:e}]})}lookupFanSpeed(r){switch(r){case 1:return"Low";case 2:case 3:return"Medium";case 4:case 5:return"MediumHigh";case 6:case 7:return"High";default:return"Off"}}parseFanSpeed(r){switch(r){case"Low":return 1;case"Medium":return 3;case"MediumHigh":return 5;case"High":return 7;default:return 0}}};var A=l(require("colors")),Ge=require("@mkellsy/hap-device");var b=require("@mkellsy/hap-device"),je=require("@mkellsy/event-emitter");var B=class extends je.EventEmitter{constructor(e,t,s,i){super();this.state=b.TriggerState.Idle;this.index=s,this.processor=e,this.action=t,this.options=m({doubleClickSpeed:300,clickSpeed:450,raiseLower:!1},i),this.button={id:this.id,index:this.index,name:(this.action.Engraving||{}).Text||this.action.Name},this.options.raiseLower===!0&&(this.button.raiseLower=!0)}get id(){return`LEAP-${this.processor.id}-BUTTON-${this.action.href.split("/")[2]}`}get definition(){return this.button}reset(){this.state=b.TriggerState.Idle,this.timer&&clearTimeout(this.timer),this.timer=void 0}update(e){let t=()=>{this.reset(),this.options.clickSpeed!==0&&this.emit("LongPress",this.button)},s=()=>{this.reset(),this.emit("Press",this.button)};switch(this.state){case b.TriggerState.Idle:{if(e.ButtonEvent.EventType==="Press"&&this.options.clickSpeed>0){this.state=b.TriggerState.Down,this.timer=setTimeout(t,this.options.clickSpeed);return}if(e.ButtonEvent.EventType==="Press"){this.state=b.TriggerState.Down,s();return}break}case b.TriggerState.Down:{if(e.ButtonEvent.EventType==="Release"){this.state=b.TriggerState.Up,this.timer&&clearTimeout(this.timer),this.options.doubleClickSpeed>0&&(this.timer=setTimeout(s,this.options.doubleClickSpeed+(this.options.raiseLower?250:0)));return}this.reset();break}case b.TriggerState.Up:{if(e.ButtonEvent.EventType==="Press"&&this.timer){if(this.reset(),this.options.doubleClickSpeed===0)return;this.emit("DoublePress",this.button);return}this.reset();break}}}};var G=class extends v{constructor(e,t,s){super(Ge.DeviceType.Keypad,e,t,s,{led:{href:"/unknown"},state:"Off"});this.buttons=[];this.triggers=new Map;(s.DeviceType==="SunnataKeypad"||s.DeviceType==="SunnataHybridKeypad"||s.DeviceType==="PalladiomKeypad")&&this.processor.buttons(this.address).then(i=>{var o,c;for(let a=0;a<(i==null?void 0:i.length);a++)for(let u=0;u<((o=i[a].Buttons)==null?void 0:o.length);u++){let g=i[a].Buttons[u],f=`LEAP-${this.processor.id}-BUTTON-${g.href.split("/")[2]}`,h=(c=g.ProgrammingModel)==null?void 0:c.ProgrammingModelType,d={id:f,index:g.ButtonNumber,name:(g.Engraving||{}).Text||g.Name,led:g.AssociatedLED,supportsLongPress:h==="AdvancedToggleProgrammingModel"};if(this.buttons.push(d),h==="AdvancedToggleProgrammingModel"){let p=new B(this.processor,g,g.ButtonNumber,{raiseLower:!1});p.on("Press",S=>{this.log.info(A.default.yellow(`Emitting Action: ${d.name} - Press`)),this.emit("Action",this,d,"Press"),setTimeout(()=>this.emit("Action",this,d,"Release"),100)}),p.on("DoublePress",S=>{this.emit("Action",this,d,"DoublePress"),setTimeout(()=>this.emit("Action",this,d,"Release"),100)}),p.on("LongPress",S=>{this.emit("Action",this,d,"LongPress"),setTimeout(()=>this.emit("Action",this,d,"Release"),100)}),this.triggers.set(g.href,p),this.processor.subscribe({href:`${g.href}/status/event`},S=>{this.log.info(A.default.green(`Keypad button event: ${g.Name} - ${S.ButtonEvent.EventType}`)),this.triggers.get(g.href).update(S)}).catch(S=>this.log.error(A.default.red(S.message)))}else{let p=0,S=null;this.processor.subscribe({href:`${g.href}/status/event`},re=>{let me=re.ButtonEvent.EventType;if(this.log.info(A.default.green(`Keypad button event (SingleAction): ${g.Name} - ${me}`)),me!=="Press")return;let ue=Date.now(),pt=ue-p;S&&(clearTimeout(S),S=null),pt<500&&p>0?(this.log.info(A.default.yellow(`Emitting Action (SingleAction): ${d.name} - DoublePress`)),this.emit("Action",this,d,"DoublePress"),setTimeout(()=>this.emit("Action",this,d,"Release"),100),p=0):(p=ue,S=setTimeout(()=>{this.log.info(A.default.yellow(`Emitting Action (SingleAction): ${d.name} - Press`)),this.emit("Action",this,d,"Press"),setTimeout(()=>this.emit("Action",this,d,"Release"),100),S=null},500))}).catch(re=>this.log.error(A.default.red(re.message)))}}}).catch(i=>this.log.error(A.default.red(i.message)))}update(){this.initialized=!0}set(e){return this.processor.update(e.led,"status",{LEDStatus:{State:e.state==="On"?"On":"Off"}})}};var ae=l(require("colors")),Je=require("@mkellsy/hap-device");var We=new Map([["Pico2Button",new Map([[0,[1,!1]],[2,[2,!1]]])],["Pico2ButtonRaiseLower",new Map([[0,[1,!1]],[2,[4,!1]],[3,[2,!0]],[4,[3,!0]]])],["Pico3Button",new Map([[0,[1,!1]],[1,[2,!1]],[2,[3,!1]]])],["Pico3ButtonRaiseLower",new Map([[0,[1,!1]],[1,[3,!1]],[2,[5,!1]],[3,[2,!0]],[4,[4,!0]]])],["Pico4Button2Group",new Map([[1,[1,!1]],[2,[2,!1]],[3,[3,!1]],[4,[4,!1]]])],["Pico4ButtonScene",new Map([[1,[1,!1]],[2,[2,!1]],[3,[3,!1]],[4,[4,!1]]])],["Pico4ButtonZone",new Map([[1,[1,!1]],[2,[2,!1]],[3,[3,!1]],[4,[4,!1]]])],["PaddleSwitchPico",new Map([[0,[1,!1]],[2,[2,!1]]])],["Pico4Button",new Map([[1,[1,!1]],[2,[2,!1]],[3,[3,!1]],[4,[4,!1]]])]]);var W=class extends v{constructor(e,t,s){super(Je.DeviceType.Remote,e,t,s,{state:"Unknown"});this.buttons=[];this.triggers=new Map;this.set=()=>Promise.resolve();this.processor.buttons(this.address).then(i=>{var o;for(let c=0;c<(i==null?void 0:i.length);c++)for(let a=0;a<((o=i[c].Buttons)==null?void 0:o.length);a++){let u=i[c].Buttons[a],g=We.get(s.DeviceType),f=g.get(u.ButtonNumber)[0],h=g.get(u.ButtonNumber)[1],d=new B(this.processor,u,f,{raiseLower:h});d.on("Press",p=>{this.emit("Action",this,p,"Press"),setTimeout(()=>this.emit("Action",this,p,"Release"),100)}),d.on("DoublePress",p=>{this.emit("Action",this,p,"DoublePress"),setTimeout(()=>this.emit("Action",this,p,"Release"),100)}),d.on("LongPress",p=>{this.emit("Action",this,p,"LongPress"),setTimeout(()=>this.emit("Action",this,p,"Release"),100)}),this.triggers.set(u.href,d),this.buttons.push(d.definition),this.processor.subscribe({href:`${u.href}/status/event`},p=>this.triggers.get(u.href).update(p)).catch(p=>this.log.error(ae.default.red(p.message)))}}).catch(i=>this.log.error(ae.default.red(i.message)))}update(){this.initialized=!0}};var Ve=l(require("deep-equal")),Ye=require("@mkellsy/hap-device");var J=class extends v{constructor(e,t,s){super(Ye.DeviceType.Occupancy,e,t,s,{state:"Unoccupied"});this.set=()=>Promise.resolve()}update(e){let t=m({},this.status);e.OccupancyStatus!=null&&(this.state.state=e.OccupancyStatus==="Occupied"?"Occupied":"Unoccupied"),(0,Ve.default)(this.state,t)||this.emit("Update",this,this.state),this.initialized=!0}};var Qe=l(require("deep-equal")),Xe=require("@mkellsy/hap-device");var V=class extends v{constructor(r,e,t){super(Xe.DeviceType.Shade,r,e,t,{state:"Closed",level:0,tilt:0}),this.fields.set("state",{type:"String",values:["Open","Closed"]}),this.fields.set("level",{type:"Integer",min:0,max:100}),this.fields.set("tilt",{type:"Integer",min:0,max:100})}update(r){let e=m({},this.status);r.Level!=null&&(this.state.state=r.Level>0?"Open":"Closed",this.state.level=r.Level),r.Tilt!=null&&(this.state.tilt=r.Tilt),this.initialized&&!(0,Qe.default)(this.state,e)&&this.emit("Update",this,this.state),this.initialized=!0}set(r){let e=[];return e.push(this.processor.command(this.address,{CommandType:"GoToLevel",Parameter:[{Type:"Level",Value:r.state==="Closed"?0:r.level}]})),(r.tilt!=null||r.state==="Closed")&&e.push(this.processor.command(this.address,{CommandType:"TiltParameters",TiltParameters:{Tilt:r.state==="Closed"?0:r.tilt}})),Promise.all(e)}};var et=l(require("deep-equal")),tt=require("@mkellsy/hap-device");var Y=class extends v{constructor(r,e,t){super(tt.DeviceType.Strip,r,e,t,{state:"Off",level:0,luminance:1800}),this.fields.set("state",{type:"String",values:["On","Off"]}),this.fields.set("level",{type:"Integer",min:0,max:100}),this.fields.set("luminance",{type:"Integer",min:1800,max:3e3})}update(r){let e=m({},this.status);r.Level!=null&&(this.state.state=r.Level>0?"On":"Off",this.state.level=r.Level),r.ColorTuningStatus!=null&&r.ColorTuningStatus.WhiteTuningLevel!=null&&r.ColorTuningStatus.WhiteTuningLevel.Kelvin!=null&&(this.state.luminance=r.ColorTuningStatus.WhiteTuningLevel.Kelvin),this.initialized&&!(0,et.default)(this.state,e)&&this.emit("Update",this,this.state),this.initialized=!0}set(r){return r.state==="Off"?this.processor.command(this.address,{CommandType:"GoToWhiteTuningLevel",WhiteTuningLevelParameters:{Level:0}}):this.processor.command(this.address,{CommandType:"GoToWhiteTuningLevel",WhiteTuningLevelParameters:{Level:r.level,WhiteTuningLevel:{Kelvin:r.luminance}}})}};var st=l(require("deep-equal")),rt=require("@mkellsy/hap-device");var Q=class extends v{constructor(r,e,t){super(rt.DeviceType.Switch,r,e,t,{state:"Off"}),this.fields.set("state",{type:"String",values:["On","Off"]})}update(r){let e=m({},this.status);this.state=P(m({},e),{state:r.SwitchedLevel||"Unknown"}),this.initialized&&!(0,st.default)(this.state,e)&&this.emit("Update",this,this.state),this.initialized=!0}set(r){return this.processor.command(this.address,{CommandType:"GoToLevel",Parameter:[{Type:"Level",Value:r.state==="On"?100:0}]})}};var it=l(require("deep-equal")),ot=require("@mkellsy/hap-device");var X=class extends v{constructor(e,t,s){super(ot.DeviceType.Timeclock,e,t,s,{state:"Off"});this.set=()=>Promise.resolve();this.fields.set("state",{type:"String",values:["On","Off"]})}update(e){let t=m({},this.status);this.state=P(m({},t),{state:e.EnabledState==="Enabled"?"On":"Off"}),this.initialized&&!(0,it.default)(this.state,t)&&this.emit("Update",this,this.state),this.initialized=!0}};var nt=require("@mkellsy/hap-device");var ee=class extends v{constructor(e,t,s){super(nt.DeviceType.Unknown,e,t,s,{state:"Unknown"});this.set=()=>Promise.resolve()}update(){}};function te(n,r,e){var s;switch(de(e.ControlType||e.DeviceType)){case y.DeviceType.Contact:return new z(n,r,e);case y.DeviceType.Dimmer:return new _(n,r,e);case y.DeviceType.Fan:return new j(n,r,e);case y.DeviceType.Keypad:return new G(n,r,e);case y.DeviceType.Occupancy:return new J(n,r,{href:`/occupancy/${(s=r.href)==null?void 0:s.split("/")[2]}`,Name:e.Name});case y.DeviceType.Remote:return new W(n,r,e);case y.DeviceType.Shade:return new V(n,r,e);case y.DeviceType.Strip:return new Y(n,r,e);case y.DeviceType.Switch:return new Q(n,r,e);case y.DeviceType.Timeclock:return new X(n,r,e);default:return new ee(n,r,e)}}function de(n){switch(n){case"Switched":case"PowPakSwitch":case"OutdoorPlugInSwitch":return y.DeviceType.Switch;case"Dimmed":case"PlugInDimmer":return y.DeviceType.Dimmer;case"Shade":return y.DeviceType.Shade;case"Timeclock":return y.DeviceType.Timeclock;case"WhiteTune":return y.DeviceType.Strip;case"FanSpeed":return y.DeviceType.Fan;case"Pico2Button":case"Pico3Button":case"Pico4Button":case"Pico3ButtonRaiseLower":return y.DeviceType.Remote;case"SunnataDimmer":case"SunnataSwitch":case"SunnataKeypad":case"SunnataHybridKeypad":case"PalladiomKeypad":return y.DeviceType.Keypad;case"RPSCeilingMountedOccupancySensor":return y.DeviceType.Occupancy;case"CCO":return y.DeviceType.Contact;default:return y.DeviceType.Unknown}}function ct(n){if(n.AddressedState!=="Addressed")return!1;switch(n.DeviceType){case"Pico2Button":case"Pico3Button":case"Pico4Button":case"Pico3ButtonRaiseLower":return!0;case"SunnataKeypad":case"SunnataHybridKeypad":case"PalladiomKeypad":return!0;case"RPSCeilingMountedOccupancySensor":return!0;default:return!1}}var at=(0,mt.get)("Client"),dt=5e3,M=class extends ut.EventEmitter{constructor(e){super(1/0);this.discovered=new Map;this.onDiscovered=e=>{if(this.discovered.delete(e.id),!this.context.has(e.id))return;let t=e.addresses.find(i=>i.family===se.HostAddressFamily.IPv4)||e.addresses[0],s=new F(e.id,new C(t.address,this.context.get(e.id)));this.discovered.set(e.id,s),s.log.info(`Processor ${R.default.green(t.address)}`),s.on("Disconnect",()=>{setTimeout(()=>this.onDiscovered(e),dt)}).on("Connect",()=>{this.refresh&&s.clear(),Promise.all([s.system(),s.project(),s.areas()]).then(([i,o,c])=>{let a=i==null?void 0:i.FirmwareImage.Firmware.DisplayName,u=i==null?void 0:i.DeviceType,g=[];s.log.info(`Firmware ${R.default.green(a||"Unknown")}`),s.log.info(o.ProductType),s.subscribe({href:"/zone/status"},f=>{for(let h of f){let d=s.devices.get(h.Zone.href);d!=null&&d.update(h)}}).catch(f=>this.onProcessorError(e,f)),s.subscribe({href:"/area/status"},f=>{var h;for(let d of f){let p=s.devices.get(`/occupancy/${(h=d.href)==null?void 0:h.split("/")[2]}`);p!=null&&d.OccupancyStatus!=null&&p.update(d)}}).catch(f=>this.onProcessorError(e,f)),u==="RadioRa3Processor"&&s.subscribe({href:"/timeclock/status"},f=>{for(let h of f){let d=s.devices.get(h.Timeclock.href);d!=null&&d.update(h)}}).catch(f=>this.onProcessorError(e,f));for(let f of c)g.push(new Promise(h=>{this.discoverZones(s,f).then(()=>h())})),g.push(new Promise(h=>{this.discoverControls(s,f).then(()=>h())}));u==="RadioRa3Processor"&&g.push(new Promise(f=>{this.discoverTimeclocks(s).then(()=>f())})),Promise.all(g).then(()=>{s.statuses(u).then(f=>{for(let h of f){let d=s.devices.get((h.Zone||{}).href||""),p=s.devices.get(`/occupancy/${(h.href||"").split("/")[2]}`);d!=null&&d.update(h),p!=null&&h.OccupancyStatus!=null&&p.update(h)}}),s.log.info(`discovered ${R.default.green([...s.devices.keys()].length.toString())} devices`),this.emit("Available",[...s.devices.values()])})}).catch(i=>this.onProcessorError(e,i))}).on("Error",i=>this.onProcessorError(e,i)),s.connect().catch(i=>this.onProcessorError(e,i))};this.onDeviceUpdate=(e,t)=>{this.emit("Update",e,t)};this.onDeviceAction=(e,t,s)=>{this.emit("Action",e,t,s)};this.onProcessorError=(e,t)=>{if(t.message==null){at.error(R.default.red(String(t)));return}if(t.message.match(/ENOTFOUND|ENETUNREACH|EHOSTUNREACH|ECONNRESET|EPIPE|ECONNREFUSED|ETIMEDOUT/g)!=null){setTimeout(()=>this.onDiscovered(e),dt);return}at.error(R.default.red(t.message))};this.context=new E,this.discovery=new k,this.refresh=e===!0,this.discovery.on("Discovered",this.onDiscovered).search()}get processors(){return[...this.discovered.keys()]}processor(e){return this.discovered.get(e)}close(){this.discovery.stop();for(let e of this.discovered.values())e.disconnect();this.discovered.clear()}discoverZones(e,t){return new Promise(s=>{if(!t.IsLeaf)return s();e.zones(t).then(i=>{for(let o of i){let c=te(e,t,P(m({},o),{Name:`${t.Name} ${o.Name}`})).on("Update",this.onDeviceUpdate).on("Action",this.onDeviceAction);e.devices.set(o.href,c)}s()}).catch(()=>s())})}discoverTimeclocks(e){return new Promise(t=>{e.timeclocks().then(s=>{for(let i of s){let o=te(e,{href:i.href,Name:i.Name,ControlType:"Timeclock",Parent:i.Parent,IsLeaf:!0,AssociatedZones:[],AssociatedControlStations:[],AssociatedOccupancyGroups:[]},P(m({},i),{ControlType:"Timeclock"})).on("Update",this.onDeviceUpdate);e.devices.set(i.href,o)}t()}).catch(()=>t())})}discoverControls(e,t){return new Promise(s=>{if(!t.IsLeaf)return s();e.controls(t).then(i=>{for(let o of i)this.discoverPositions(e,o).then(c=>{var a;for(let u of c){let f=de(u.DeviceType)===se.DeviceType.Occupancy?`/occupancy/${(a=t.href)==null?void 0:a.split("/")[2]}`:u.href,h=te(e,t,P(m({},u),{Name:`${t.Name} ${o.Name} ${u.Name}`})).on("Update",this.onDeviceUpdate).on("Action",this.onDeviceAction);e.devices.set(f,h)}s()})}).catch(()=>s())})}discoverPositions(e,t){return new Promise(s=>{if(t.AssociatedGangedDevices==null)return s([]);let i=[];for(let o of t.AssociatedGangedDevices)i.push(e.device(o.Device));Promise.all(i).then(o=>{s(o.filter(c=>ct(c)))}).catch(()=>s([]))})}};function Et(n){return new M(n)}function kt(){return new Promise((n,r)=>{let e=new k,t=new E;e.on("Discovered",s=>{t.get(s.id)==null&&new $(s).authenticate().then(o=>{t.set(s,o),n()}).catch(o=>r(o)).finally(()=>e.stop())}),e.search()})}0&&(module.exports={Client,connect,pair});
//# sourceMappingURL=index.js.map
